# 🤖 카카오톡 오픈채팅 자동 전송 시스템

G라이더 미션 현황을 카카오톡 오픈채팅방에 자동으로 전송하는 시스템입니다.

## 📋 주요 기능

- 📊 **정기 미션 현황 리포트**: 설정된 시간마다 자동으로 미션 진행 상황을 전송
- ⚠️ **중복 메시지 방지**: 동일한 내용의 메시지는 10분 이내 재전송 차단
- 📈 **전송 통계 관리**: 성공/실패 통계 및 성공률 추적
- 🔄 **스케줄 관리**: 유연한 시간 설정으로 맞춤형 알림
- 🧪 **테스트 기능**: 실제 전송 전 테스트 메시지로 동작 확인

## 🚀 빠른 시작

### 1. 초기 설정

```bash
# 설정 스크립트 실행
python setup_kakao_schedule.py
```

### 2. 환경변수 설정

생성된 `.env` 파일을 편집하여 실제 값으로 변경:

```env
# 카카오 API 설정
KAKAO_API_BASE_URL=https://kapi.kakao.com
KAKAO_ADMIN_KEY=your_actual_admin_key
KAKAO_OPENCHAT_ID=your_actual_chat_id
KAKAO_BOT_USER_ID=your_actual_bot_id
```

### 3. 시스템 실행

```bash
# 직접 실행
python kakao_scheduled_sender.py

# 또는 시작 스크립트 사용
./start_kakao_sender.sh
```

## 📅 기본 스케줄

- **주요 알림**: 08:00, 12:00, 18:00, 22:00 (일 4회)
- **피크 알림**: 10:30, 14:30, 20:30 (추가 3회)

## 🛠️ 카카오 API 설정 방법

### 1. 카카오 개발자 콘솔 설정

1. [카카오 개발자 콘솔](https://developers.kakao.com/) 접속
2. **내 애플리케이션** → **애플리케이션 추가하기**
3. **앱 키** → **REST API 키** 복사 (`KAKAO_ADMIN_KEY`)

### 2. 카카오톡 메시지 API 활성화

1. **제품 설정** → **카카오톡 메시지** 클릭
2. **활성화 설정** → **ON**
3. **카카오톡 채널** 연결 (선택사항)

### 3. 권한 설정

1. **동의항목**에서 다음 권한 추가:
   - `talk_message` (카카오톡 메시지 전송)
   - `friends` (친구 목록 조회)

### 4. 플랫폼 등록

1. **플랫폼** → **Web 플랫폼 등록**
2. 사이트 도메인 입력: `http://localhost:5000`

## 📱 오픈채팅방 설정

### 1. 오픈채팅방 생성/참여

1. 카카오톡에서 오픈채팅방 생성 또는 기존 방 참여
2. **관리자 권한** 필요 (메시지 전송을 위해)

### 2. 채팅방 ID 확인

채팅방 ID는 카카오 API를 통해 확인할 수 있습니다:

```python
# 친구/채팅방 목록 조회 API 사용
# 자세한 방법은 카카오 개발자 문서 참조
```

## 🎮 사용법

시스템 실행 후 메뉴에서 선택:

```
📋 메뉴:
1. 스케줄러 시작      # 자동 전송 시작
2. 스케줄러 중지      # 자동 전송 중지  
3. 테스트 메시지 전송  # 테스트용 메시지
4. 현재 상태 확인     # 스케줄러 상태
5. 즉시 미션 현황 전송 # 수동 전송
6. 통계 확인         # 전송 통계
0. 종료             # 프로그램 종료
```

## 📊 메시지 형태

자동 전송되는 메시지 예시:

```
📊 미션 현황 리포트
🌅 아침점심피크: 18/20 ✅ (달성)
🌇 오후논피크: 156/200 ❌ (44건 부족)
🌃 저녁피크: 23/25 ❌ (2건 부족)
🌙 심야논피크: 13/20 ❌ (7건 부족)

──────────────────────

🌤️ 안산 날씨
현재: 맑음 🌞 18°C
오늘: 최고 22°C, 최저 12°C
습도: 65% | 바람: 북서 2.1m/s

──────────────────────

총점: 847점 (물량:520, 수락률:327)
수락률: 89.2% | 완료: 210 | 거절: 26

──────────────────────

🏆 TOP 3 라이더
🥇 김라이더 | [■■■■■■■■■───] 82.5%
    └ 총 45건 (아침:12/오후:18/저녁:10/심야:5)
    └ 수락률: 94.2% (거절:3, 취소:1)

🥈 박기사 | [■■■■■■■■──────] 68.7%
    └ 총 38건 (아침:8/오후:15/저녁:12/심야:3)
    └ 수락률: 90.5% (거절:4, 취소:0)

🥉 이드라이버 | [■■■■■■■─────] 62.3%
    └ 총 32건 (아침:6/오후:12/저녁:8/심야:6)
    └ 수락률: 86.5% (거절:5, 취소:2)

───────────────
🏃 그 외 라이더
4. 최운전 (45.2%)
   └ 총 24건 (아침:4/오후:8/저녁:7/심야:5)
   └ 수락률: 82.8% (거절:5, 취소:1)

5. 정배송 (38.1%)
   └ 총 19건 (아침:3/오후:6/저녁:5/심야:5)
   └ 수락률: 79.2% (거절:5, 취소:3)

──────────────────────
⚠️ 미션 부족: 오후논피크 44건, 저녁피크 2건, 심야논피크 7건

(그래프 이미지는 첨부파일로 전송됩니다.)
```

**실제 카카오톡에서 전송되는 형태** (HTML 태그 적용):

```
📊 미션 현황 리포트
📅 2024-01-15 14:30

🌅 아침점심피크: 18/20 ✅ (달성)
🌇 오후논피크: 156/200 ❌ (44건 부족)
🌃 저녁피크: 23/25 ❌ (2건 부족)
🌙 심야논피크: 13/20 ❌ (7건 부족)

━━━━━━━━━━━━━━━━━━━━━━
🔄 자동 업데이트 | 🤖 G라이더 미션봇
```

## 🔧 고급 설정

### 스케줄 커스터마이징

`kakao_scheduled_sender.py`에서 스케줄 수정:

```python
def setup_schedules(self):
    # 원하는 시간으로 변경
    schedule.every().day.at("09:00").do(self._safe_send_message)
    schedule.every().day.at("15:00").do(self._safe_send_message)
    
    # 더 자주 보내려면
    schedule.every(30).minutes.do(self._safe_send_message)
```

### 메시지 포맷 변경

`_format_message` 메서드에서 메시지 형식 수정 가능

## 🛡️ 자동 실행 설정

### Linux (systemd)

```bash
# 서비스 파일 복사
sudo cp kakao-auto-sender.service /etc/systemd/system/

# 서비스 등록 및 시작
sudo systemctl daemon-reload
sudo systemctl enable kakao-auto-sender.service
sudo systemctl start kakao-auto-sender.service

# 상태 확인
sudo systemctl status kakao-auto-sender.service
```

### Windows (작업 스케줄러)

1. **작업 스케줄러** 실행
2. **기본 작업 만들기** 선택
3. **시작 프로그램**: `python.exe`
4. **인수**: `카카오톡_자동전송_폴더경로\kakao_scheduled_sender.py`
5. **트리거**: 시스템 시작 시

### macOS (launchd)

```bash
# LaunchAgent 생성
mkdir -p ~/Library/LaunchAgents
cp com.kakao.autosender.plist ~/Library/LaunchAgents/

# 서비스 로드
launchctl load ~/Library/LaunchAgents/com.kakao.autosender.plist
```

## 📈 모니터링 및 로그

### 로그 파일 위치

- **스케줄러 로그**: `logs/kakao_scheduler.log`
- **전송 상태**: 콘솔 출력 및 로그 파일

### 로그 모니터링

```bash
# 실시간 로그 보기
tail -f logs/kakao_scheduler.log

# 오류만 보기
grep "ERROR" logs/kakao_scheduler.log
```

## ❓ 문제 해결

### 자주 발생하는 문제

1. **API 키 오류**
   - `.env` 파일의 키 값 확인
   - 카카오 개발자 콘솔에서 키 재발급

2. **권한 오류**
   - 카카오톡 메시지 API 활성화 확인
   - 필요한 동의항목 체크

3. **메시지 전송 실패**
   - 네트워크 연결 확인
   - 카카오 API 서버 상태 확인
   - 일일 전송 한도 확인

4. **모듈 import 오류**
   - `main_(2).py` 파일 존재 확인
   - 필요한 패키지 설치: `pip install -r requirements.txt`

### 디버깅 방법

```python
# 테스트 메시지로 연결 확인
python -c "
from kakao_scheduled_sender import ScheduleManager
manager = ScheduleManager()
manager.send_test_message()
"
```

## 📞 지원

- **카카오 API 문서**: https://developers.kakao.com/docs/latest/ko/message/
- **이슈 리포트**: GitHub Issues 섹션 이용
- **기술 지원**: 프로젝트 담당자에게 문의

## 📄 라이선스

이 프로젝트는 MIT 라이선스 하에 배포됩니다.

---

🤖 **G라이더 미션봇으로 효율적인 미션 관리를 시작하세요!** 

## 📋 **목차**
1. [기본 설정](#1-기본-설정)
2. [GitHub Secrets 설정](#2-github-secrets-설정)
3. [한국천문연구원 특일 정보 API 설정](#3-한국천문연구원-특일-정보-api-설정) 🆕
4. [카카오 i 오픈빌더 설정](#4-카카오-i-오픈빌더-설정)
5. [테스트 및 배포](#5-테스트-및-배포)

---

## 1. 기본 설정

### 1.1 저장소 준비
```bash
git clone [저장소 URL]
cd [프로젝트 폴더]
```

### 1.2 필요한 패키지 설치
```bash
pip install -r requirements.txt
```

---

## 2. GitHub Secrets 설정

GitHub 저장소 → **Settings** → **Secrets and variables** → **Actions**

### 2.1 필수 환경변수
```
KAKAO_ACCESS_TOKEN: 카카오 액세스 토큰
KAKAO_OPENCHAT_ID: 오픈채팅방 ID
KAKAO_OPENBUILDER_WEBHOOK: 카카오 i 오픈빌더 웹훅 URL
KOREA_HOLIDAY_API_KEY: 한국천문연구원 특일 정보 API 키 🆕
WEATHER_API_KEY: 기상청 날씨 API 키 (선택)
```

---

## 3. 한국천문연구원 특일 정보 API 설정 🆕

### 3.1 왜 필요한가요?
❌ **기존 문제점**:
- 일반 라이브러리는 **기본 법정공휴일**만 지원
- **임시 공휴일**이나 **대체 공휴일** 누락
- 정부 발표 후 즉시 반영 안됨

✅ **해결 방법**:
- **한국천문연구원 공식 API** 사용
- **임시/대체 공휴일** 실시간 반영
- 정부 발표 **1-2일 내** 자동 업데이트

### 3.2 API 키 발급 방법

#### Step 1: 공공데이터포털 회원가입
1. **https://www.data.go.kr/** 접속
2. 회원가입 (간편인증 가능)

#### Step 2: API 활용신청
1. **검색**: "한국천문연구원 특일 정보"
2. **API 상세페이지** 접속
3. **"활용신청"** 클릭

#### Step 3: 신청 정보 입력
```
서비스명: G라이더 자동화 시스템
활용목적: 공휴일 자동 인식을 통한 메시지 스케줄링
기관유형: 개인
승인유형: 자동승인 (즉시 사용 가능)
```

#### Step 4: API 키 확인
- 승인 즉시 **"마이페이지" → "개발계정"**에서 확인
- 일반 인증키 (Decoding) 복사

### 3.3 GitHub Secrets에 추가
```
Secret Name: KOREA_HOLIDAY_API_KEY
Secret Value: [발급받은 API 키]
```

### 3.4 테스트 방법
```python
# 터미널에서 테스트
export KOREA_HOLIDAY_API_KEY="your_api_key_here"
python github_actions_sender.py
```

**예상 출력**:
```
🇰🇷 한국천문연구원 특일 정보 API 공휴일 체커 초기화
📅 공휴일 확인: 2024-01-01 - 신정
📅 공휴일 확인: 2024-02-09 - 설날
📅 공휴일 확인: 2024-02-12 - 대체공휴일(설날)
✅ 2024년 전체월 공휴일 16개 로드 완료
```

### 3.5 지원하는 공휴일 유형

| 유형 | 예시 | 특징 |
|-----|------|------|
| 🎄 **법정공휴일** | 신정, 설날, 추석 | 기본 법정 공휴일 |
| 🔄 **대체공휴일** | 대체공휴일(설날) | 주말과 겹칠 때 지정 |
| ⚡ **임시공휴일** | 임시공휴일 | 정부에서 특별 지정 |
| 🎯 **특별공휴일** | 선거일, 특별휴일 | 기타 특별 지정일 |

---

## 4. 카카오 i 오픈빌더 설정

### 4.1 오픈빌더 챗봇 생성
1. **https://i.kakao.com** 접속
2. 봇 생성: "G라이더 자동 리포터"

### 4.2 웹훅 설정
- 웹훅 URL을 GitHub Secrets에 추가
- 카카오톡 채팅방에 봇 초대

---

## 5. 테스트 및 배포

### 5.1 수동 테스트
```bash
# GitHub Actions에서 수동 실행
GitHub → Actions → "Run workflow"
```

### 5.2 자동 스케줄 확인

**📅 한국시간(KST) 기준 스케줄**:
- **09:00**: 🌅 화이팅 넘치는 첫 메시지
- **09:30~23:30**: 📊 30분 간격 기본 전송
- **피크시간**: 🔥 15분 간격 추가 전송
  - 평일: 06:00~13:00, 17:00~20:00
  - 휴일: 06:00~14:00, 17:00~20:00
- **00:00**: 🌙 감동적인 마무리 메시지

### 5.3 공휴일 인식 확인
실행 로그에서 다음과 같은 메시지 확인:
```
🇰🇷 한국시간(KST): 2024-02-12 09:00:00
📅 요일: 월요일
🎄 공휴일: 예 - 🔄 대체공휴일: 대체공휴일(설날)
⚡ 특별공휴일: 임시/대체 공휴일입니다!
🏠 휴일여부: 예
```

---

## 🎯 **완성된 자동화 시스템의 특징**

### ✅ **정확한 공휴일 인식**
- **임시 공휴일**: 정부 발표 1-2일 내 자동 반영
- **대체 공휴일**: 주말과 겹치는 공휴일 자동 처리
- **선거일**: 전국동시지방선거 등 자동 인식

### ✅ **스마트 메시지**
- 공휴일 종류에 따른 **맞춤 인사**
- **임시/대체 공휴일** 특별 안내
- **피크시간 자동 조정** (휴일/평일 구분)

### ✅ **무인 운영**
- **24/7 완전 자동화**
- **한국시간 정확 반영**
- **API 장애시 폴백** 시스템

---

## ⚠️ **주의사항**

1. **API 할당량**: 개발계정 일 10,000회 (충분함)
2. **정확성**: 공식 API이므로 99.9% 정확
3. **업데이트**: 정부 발표 후 1-2일 내 자동 반영
4. **비용**: 완전 무료

---

## 🆘 **문제 해결**

### Q. API 키가 작동하지 않아요
A. 공공데이터포털에서 활용신청 승인 상태를 확인하세요

### Q. 임시 공휴일이 반영 안돼요
A. 정부 발표 후 1-2일 정도 소요됩니다

### Q. GitHub Actions가 실행 안돼요
A. Secrets 설정과 한국시간 cron 설정을 확인하세요

---

## 🎉 **완성!**

이제 **세계 최고 수준의 한국 공휴일 인식 시스템**을 갖춘 
**완전 무인 자동화 G라이더 리포터**가 완성되었습니다! 🚀

**임시 공휴일**이나 **대체 공휴일**까지 완벽하게 인식하여
정확한 시간에 정확한 메시지를 전송합니다! 💪 