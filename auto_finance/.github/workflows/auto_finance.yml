name: ğŸ“ˆ ìë™ ê¸ˆìœµ ë‰´ìŠ¤ ì‹œìŠ¤í…œ

on:
  schedule:
    # í•œêµ­ì‹œê°„ ê¸°ì¤€ ìŠ¤ì¼€ì¤„ (UTC+9)
    # ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 12ì‹œ, ì˜¤í›„ 3ì‹œ, ì˜¤í›„ 6ì‹œ, ì˜¤í›„ 9ì‹œ
    - cron: '0 0,3,6,9,12 * * *'  # UTC 00:00, 03:00, 06:00, 09:00, 12:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]
    paths:
      - 'auto_finance/**'

env:
  PYTHON_VERSION: '3.9'
  TZ: 'Asia/Seoul'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: ğŸ“… ì‹œê°„ëŒ€ í™•ì¸
        id: check
        run: |
          # í•œêµ­ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰ ì—¬ë¶€ ê²°ì •
          CURRENT_HOUR=$(TZ=Asia/Seoul date +%H)
          echo "í˜„ì¬ í•œêµ­ì‹œê°„: $CURRENT_HOURì‹œ"
          
          # ì¥ ì‹œê°„ëŒ€ (9ì‹œ-15ì‹œ) ë˜ëŠ” ì €ë… ì‹œê°„ëŒ€ (18ì‹œ-21ì‹œ)ì—ë§Œ ì‹¤í–‰
          if [ "$CURRENT_HOUR" -ge 9 ] && [ "$CURRENT_HOUR" -le 15 ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "âœ… ì¥ ì‹œê°„ëŒ€ - ì‹¤í–‰ ì˜ˆì •"
          elif [ "$CURRENT_HOUR" -ge 18 ] && [ "$CURRENT_HOUR" -le 21 ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "âœ… ì €ë… ì‹œê°„ëŒ€ - ì‹¤í–‰ ì˜ˆì •"
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "â° ë¹„í™œì„± ì‹œê°„ëŒ€ - ì‹¤í–‰ ê±´ë„ˆëœ€"
          fi

  auto-finance-automation:
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd auto_finance
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          cd auto_finance
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "TISTORY_ACCESS_TOKEN=${{ secrets.TISTORY_ACCESS_TOKEN }}" >> .env
          echo "TISTORY_BLOG_NAME=${{ secrets.TISTORY_BLOG_NAME }}" >> .env
          echo "TISTORY_CATEGORY_ID=${{ secrets.TISTORY_CATEGORY_ID }}" >> .env
          echo "CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          
      - name: ğŸ” í™˜ê²½ ê²€ì¦
        run: |
          cd auto_finance
          python -c "
          import sys
          sys.path.append('.')
          from config.settings import settings
          from config.credentials import credentials
          
          print('ğŸ” ì„¤ì • ê²€ì¦ ì¤‘...')
          if settings.validate_config():
              print('âœ… ì„¤ì • ê²€ì¦ ì™„ë£Œ')
          else:
              print('âŒ ì„¤ì • ê²€ì¦ ì‹¤íŒ¨')
              sys.exit(1)
              
          print('ğŸ”‘ ì¸ì¦ ì •ë³´ ê²€ì¦ ì¤‘...')
          validation = credentials.validate_required_credentials()
          if validation['valid']:
              print('âœ… ì¸ì¦ ì •ë³´ ê²€ì¦ ì™„ë£Œ')
          else:
              print(f'âŒ ì¸ì¦ ì •ë³´ ëˆ„ë½: {validation[\"missing\"]}')
              sys.exit(1)
          "
          
      - name: ğŸš€ ìë™ ê¸ˆìœµ ë‰´ìŠ¤ ì‹œìŠ¤í…œ ì‹¤í–‰
        run: |
          cd auto_finance
          echo "ğŸ• ì‹¤í–‰ ì‹œì‘: $(TZ=Asia/Seoul date)"
          
          # ë‹¨ì¼ ì‹¤í–‰ ëª¨ë“œë¡œ ì‹¤í–‰
          python main.py
          
          echo "ğŸ• ì‹¤í–‰ ì™„ë£Œ: $(TZ=Asia/Seoul date)"
          
      - name: ğŸ“Š ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: auto-finance-results
          path: |
            auto_finance/logs/
            auto_finance/data/statistics.json
            auto_finance/cache/
          retention-days: 7
          
      - name: ğŸ“ˆ ì„±ê³¼ ë¦¬í¬íŠ¸ ìƒì„±
        if: always()
        run: |
          cd auto_finance
          
          echo "ğŸ“Š ìë™ ê¸ˆìœµ ë‰´ìŠ¤ ì‹œìŠ¤í…œ ì„±ê³¼ ë¦¬í¬íŠ¸" > performance_report.md
          echo "=====================================" >> performance_report.md
          echo "" >> performance_report.md
          echo "ì‹¤í–‰ ì‹œê°„: $(TZ=Asia/Seoul date)" >> performance_report.md
          echo "" >> performance_report.md
          
          if [ -f "data/statistics.json" ]; then
              echo "ğŸ“ˆ í†µê³„ ì •ë³´:" >> performance_report.md
              cat data/statistics.json | python -m json.tool >> performance_report.md
          else
              echo "âš ï¸ í†µê³„ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> performance_report.md
          fi
          
          echo "" >> performance_report.md
          echo "ğŸ“ ìµœê·¼ ë¡œê·¸:" >> performance_report.md
          if [ -f "logs/crawler.log" ]; then
              tail -20 logs/crawler.log >> performance_report.md
          fi
          
      - name: ğŸ“¤ ì„±ê³¼ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: auto_finance/performance_report.md
          retention-days: 30

  notification:
    needs: auto-finance-automation
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: performance-report
          
      - name: ğŸ“± ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ (ì„±ê³µ)
        if: needs.auto-finance-automation.result == 'success'
        run: |
          echo "âœ… ìë™ ê¸ˆìœµ ë‰´ìŠ¤ ì‹œìŠ¤í…œ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          
          # ì„±ê³¼ ë¦¬í¬íŠ¸ ë‚´ìš© ì½ê¸°
          if [ -f "performance_report.md" ]; then
              REPORT_CONTENT=$(cat performance_report.md)
              echo "ğŸ“Š ì„±ê³¼ ë¦¬í¬íŠ¸:"
              echo "$REPORT_CONTENT"
          fi
          
      - name: ğŸ“± ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ (ì‹¤íŒ¨)
        if: needs.auto-finance-automation.result == 'failure'
        run: |
          echo "âŒ ìë™ ê¸ˆìœµ ë‰´ìŠ¤ ì‹œìŠ¤í…œ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
          
      - name: ğŸ§¹ ì •ë¦¬
        if: always()
        run: |
          echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬ ì¤‘..."
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -rf auto_finance/cache/*
          rm -rf auto_finance/logs/*.tmp 