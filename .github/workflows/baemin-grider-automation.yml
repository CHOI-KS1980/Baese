name: ğŸ• ë°°ë¯¼ Gë¼ì´ë” ë¯¸ì…˜ ìë™í™”

on:
  schedule:
    # === í•œêµ­ì‹œê°„(KST) ê¸°ì¤€ ìŠ¤ì¼€ì¤„ë§ ===
    # KST = UTC + 9ì‹œê°„ì´ë¯€ë¡œ UTC ì‹œê°„ì€ -9ì‹œê°„ìœ¼ë¡œ ì„¤ì •
    
    # ğŸŒ… ì•„ì¹¨ ì²« ë©”ì‹œì§€ 09:00 KST (00:00 UTC)
    - cron: '0 0 * * *'
    
    # ğŸ“Š ê¸°ë³¸ 30ë¶„ ê°„ê²©: 09:30~23:30 KST (00:30~14:30 UTC)
    - cron: '30 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14 * * *'
    
    # ğŸ”¥ í‰ì¼ í”¼í¬ì‹œê°„ 15ë¶„ ê°„ê²© ì¶”ê°€
    # ì•„ì¹¨ì ì‹¬í”¼í¬: 06:00~13:00 KST = 21:00(ì „ë‚ )~04:00 UTC
    - cron: '15,45 21,22,23 * * 0-4'  # ì „ë‚  ì €ë… 21-23ì‹œ (ì›”-ê¸ˆ)
    - cron: '15,45 0,1,2,3 * * 1-5'   # ë‹¹ì¼ ìƒˆë²½ 0-3ì‹œ (í™”-í† )
    
    # ì €ë…í”¼í¬: 17:00~20:00 KST = 08:00~11:00 UTC
    - cron: '15,45 8,9,10 * * 1-5'    # ì˜¤ì „ 8-10ì‹œ (ì›”-ê¸ˆ)
    
    # ğŸ‰ íœ´ì¼ í”¼í¬ì‹œê°„ 15ë¶„ ê°„ê²© ì¶”ê°€ (í† ,ì¼)
    # ì•„ì¹¨ì ì‹¬í”¼í¬: 06:00~14:00 KST = 21:00(ì „ë‚ )~05:00 UTC
    - cron: '15,45 21,22,23 * * 5,6'  # ê¸ˆí†  ì €ë… (í† ì¼ ì¤€ë¹„)
    - cron: '15,45 0,1,2,3,4 * * 0,6' # ì¼ì›” ìƒˆë²½ (ì¼í†  ì‹œê°„)
    
    # íœ´ì¼ ì €ë…í”¼í¬: 17:00~20:00 KST = 08:00~11:00 UTC  
    - cron: '15,45 8,9,10 * * 0,6'    # í† ì¼ ì˜¤ì „ 8-10ì‹œ
    
    # ğŸŒ™ ë§ˆë¬´ë¦¬ ë©”ì‹œì§€: ìì • 00:00 KST = 15:00 UTC (ì „ë‚ )
    - cron: '0 15 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:
    inputs:
      message_type:
        description: 'ì „ì†¡í•  ë©”ì‹œì§€ íƒ€ì…'
        required: false
        default: 'manual'
        type: choice
        options:
        - manual
        - test
        - emergency
        - status_check

jobs:
  send-baemin-grider-mission:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ›’ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •  
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 python-dotenv pytz schedule holidays
    
    - name: ğŸ• ì‹¤í–‰ ì‹œê°„ ì •ë³´
      run: |
        echo "ğŸš€ ë°°ë¯¼ Gë¼ì´ë” ìë™í™” ì‹œì‘"
        echo "â° UTC ì‹œê°„: $(date -u)"
        echo "ğŸ‡°ğŸ‡· í•œêµ­ ì‹œê°„ (KST): $(TZ='Asia/Seoul' date)"
        echo "ğŸ¯ ì‹¤í–‰ íƒ€ì…: ${{ github.event.inputs.message_type || 'scheduled' }}"
        echo "ğŸ”„ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
    
    - name: ğŸ• ë°°ë¯¼ Gë¼ì´ë” ë¯¸ì…˜ ì „ì†¡
      env:
        # ì¹´ì¹´ì˜¤ i ì˜¤í”ˆë¹Œë” ì—°ë™
        KAKAO_ACCESS_TOKEN: ${{ secrets.KAKAO_ACCESS_TOKEN }}
        KAKAO_OPENCHAT_ID: ${{ secrets.KAKAO_OPENCHAT_ID }}
        KAKAO_OPENBUILDER_WEBHOOK: ${{ secrets.KAKAO_OPENBUILDER_WEBHOOK }}
        
        # í•œêµ­ ê³µíœ´ì¼ API
        KOREA_HOLIDAY_API_KEY: ${{ secrets.KOREA_HOLIDAY_API_KEY }}
        
        # ì›¹í›… ì‹œìŠ¤í…œ (ì´ì¤‘í™”)
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        FALLBACK_WEBHOOK_URL: ${{ secrets.FALLBACK_WEBHOOK_URL }}
        
        # ë‚ ì”¨ ì •ë³´ (ì„ íƒì‚¬í•­)
        WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        
        # ë””ë²„ê·¸ ëª¨ë“œ
        DEBUG_MODE: ${{ github.event.inputs.message_type == 'test' && 'true' || 'false' }}
      run: |
        echo "ğŸ¯ ë°°ë¯¼ Gë¼ì´ë” ë¯¸ì…˜ ìë™ ì „ì†¡ ì‹œì‘..."
        echo "ğŸ”‘ API í‚¤ í™•ì¸:"
        echo "  - ì¹´ì¹´ì˜¤ í† í°: ${KAKAO_ACCESS_TOKEN:0:10}..."
        echo "  - ê³µíœ´ì¼ API: ${KOREA_HOLIDAY_API_KEY:0:10}..."
        echo "  - ë‚ ì”¨ API: ${WEATHER_API_KEY:0:10}..."
        
        python github_actions_sender.py
        
        echo "âœ… ë°°ë¯¼ Gë¼ì´ë” ë¯¸ì…˜ ì „ì†¡ ì™„ë£Œ!"
    
    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ• ë°°ë¯¼ Gë¼ì´ë” ìë™í™” ì‹¤í–‰ ì™„ë£Œ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â° ì™„ë£Œ ì‹œê°„ (UTC): $(date -u)"
        echo "ğŸ‡°ğŸ‡· ì™„ë£Œ ì‹œê°„ (KST): $(TZ='Asia/Seoul' date)"
        echo "ğŸ¯ ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}"
        echo "ğŸ”„ ì‹¤í–‰ ê²°ê³¼: ${{ job.status }}"
        echo "ğŸ“ ì»¤ë°‹ í•´ì‹œ: ${{ github.sha }}"
        echo "ğŸŒ ì €ì¥ì†Œ: ${{ github.repository }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "âœ… ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“± ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "âŒ ì¼ë¶€ ì‘ì—…ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
        fi

  # ì‹¤íŒ¨ ì•Œë¦¼ ì‹œìŠ¤í…œ
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: send-baemin-grider-mission
    if: failure()
    
    steps:
    - name: ğŸš¨ ìë™í™” ì‹¤íŒ¨ ì•Œë¦¼
      run: |
        echo "âŒ ë°°ë¯¼ Gë¼ì´ë” ìë™í™” ì‹¤íŒ¨!"
        echo "â° ì‹¤íŒ¨ ì‹œê°„ (KST): $(TZ='Asia/Seoul' date)"
        echo "ğŸ” GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
        echo "ğŸ“§ í•„ìš”ì‹œ ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ì„ ë°œì†¡í•˜ì„¸ìš”." 