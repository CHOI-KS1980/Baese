name: ğŸŒŸ ì°¨ì„¸ëŒ€ Gë¼ì´ë” ìë™í™” ì‹œìŠ¤í…œ

on:
  push:
    branches: [ "main" ]
  schedule:
    # ë¹„í”¼í¬ì‹œê°„: ì •ê°, 30ë¶„ (UTC ê¸°ì¤€ì´ë¯€ë¡œ í•œêµ­ì‹œê°„ -9ì‹œê°„)
    - cron: '0,30 1-8,14 * * *'    # í•œêµ­ì‹œê°„ 10:00, 10:30, 11:00, 11:30, 12:00, 12:30, 17:00, 17:30, 23:00, 23:30
    # í”¼í¬ì‹œê°„: 15ë¶„ ê°„ê²©
    - cron: '15,45 2-5,8-12 * * *' # í•œêµ­ì‹œê°„ 11:15, 11:45, 12:15, 12:45, 17:15, 17:45, 18:00~21:45
    - cron: '0,15,30,45 2-5,8-12 * * *' # í”¼í¬ì‹œê°„ ëª¨ë“  15ë¶„ ê°„ê²©
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: false
        default: 'ultimate'
        type: choice
        options:
          - ultimate
          - ai_only
          - optimization
          - status_check
      priority:
        description: 'ìš°ì„ ìˆœìœ„'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - high
          - emergency

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

permissions:
  contents: write

jobs:
  ultimate-automation:
    name: ğŸŒŸ ì°¨ì„¸ëŒ€ ìë™í™” ì‹¤í–‰
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        check-latest: false
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip --quiet
        pip install --prefer-binary -r requirements.txt --quiet
        pip install psutil --quiet

    - name: ğŸš€ Chrome ìµœì í™” ì„¤ì •
      run: |
        # Chromeì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if command -v google-chrome >/dev/null 2>&1; then
          echo "âœ… Chrome ì´ë¯¸ ì„¤ì¹˜ë¨: $(google-chrome --version)"
        else
          echo "ğŸ”„ Chrome ì„¤ì¹˜ ì¤‘..."
          sudo apt-get update -qq
          sudo apt-get install -y google-chrome-stable --quiet
        fi
        
        # ChromeDriver ë™ì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ (ì•ˆì •ì„± ê°•í™” v2)
        CHROME_BUILD_VERSION=$(google-chrome --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        echo "ğŸ¤” Chrome ë¹Œë“œ ë²„ì „: $CHROME_BUILD_VERSION"
        
        # í•´ë‹¹ ë¹Œë“œ ë²„ì „ì— ë§ëŠ” ìµœì‹  ë“œë¼ì´ë²„ ë²„ì „ ì°¾ê¸°
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_BUILD_VERSION}")
        
        if [ -z "$CHROMEDRIVER_VERSION" ]; then
          echo "âŒ ${CHROME_BUILD_VERSION} ë²„ì „ì— ë§ëŠ” ChromeDriverë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•Œë ¤ì§„ ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤."
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | jq -r '.channels.Stable.version')
        fi
        
        echo "ğŸ“¥ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
        
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
        unzip -q chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        echo "âœ… Chrome ì„¤ì • ì™„ë£Œ"

    - name: ğŸŒŸ ì°¨ì„¸ëŒ€ ì‹œìŠ¤í…œ ì‹¤í–‰
      env:
        GRIDER_ID: ${{ secrets.GRIDER_ID }}
        GRIDER_PASSWORD: ${{ secrets.GRIDER_PASSWORD }}
        KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
        KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
        KOREA_HOLIDAY_API_KEY: ${{ secrets.KOREA_HOLIDAY_API_KEY }}
      run: |
        # 1. config.txtë¥¼ semiauto í´ë” ì•ˆì— ì§ì ‘ ìƒì„± (cd ì‚¬ìš© ì•ˆí•¨)
        echo "âœ… í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì™„ë£Œ"
        cat > semiauto/config.txt << EOF
        REST_API_KEY=${KAKAO_REST_API_KEY}
        REFRESH_TOKEN=${KAKAO_REFRESH_TOKEN}
        GRIDER_ID=${GRIDER_ID}
        GRIDER_PASSWORD=${GRIDER_PASSWORD}
        KOREA_HOLIDAY_API_KEY=${KOREA_HOLIDAY_API_KEY}
        EOF
        echo "âœ… ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ: semiauto/config.txt"

        # 2. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ final_solution.pyë¥¼ ëª¨ë“ˆë¡œ ì‹¤í–‰
        echo "ğŸš€ G-Rider ìë™í™” ì‹œìŠ¤í…œ ì‹¤í–‰"
        python -m semiauto.core.final_solution

    - name: ğŸ” ê²°ê³¼ ë¶„ì„
      if: always()
      run: |
        cd semiauto
        # í¬ë¡¤ë§ ê²°ê³¼ ìƒì„¸ ë¶„ì„
        echo "ğŸ” í¬ë¡¤ë§ ê²°ê³¼ ìƒì„¸ ë¶„ì„"
        echo "================================"
        
        # ë””ë²„ê·¸ íŒŒì¼ í™•ì¸
        if [ -f "debug_grider_page.html" ]; then
          echo "âœ… ì„±ê³µí•œ í¬ë¡¤ë§ í˜ì´ì§€ ë°œê²¬"
          echo "ğŸ“„ íŒŒì¼ í¬ê¸°: $(ls -lh debug_grider_page.html | awk '{print $5}')"
          echo "ğŸ“Š HTML ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
          head -n 20 debug_grider_page.html | grep -E "(title|login|error|alert)" || echo "   íŠ¹ë³„í•œ ë‚´ìš© ì—†ìŒ"
        else
          echo "âŒ ì„±ê³µí•œ í¬ë¡¤ë§ í˜ì´ì§€ ì—†ìŒ"
        fi
        
        # ì‹¤íŒ¨í•œ í¬ë¡¤ë§ íŒŒì¼ë“¤ í™•ì¸
        for file in debug_failed_page_*.html; do
          if [ -f "$file" ]; then
            echo "âš ï¸ ì‹¤íŒ¨í•œ í¬ë¡¤ë§ í˜ì´ì§€: $file"
            echo "ğŸ“„ íŒŒì¼ í¬ê¸°: $(ls -lh "$file" | awk '{print $5}')"
            echo "ğŸ“Š ì‹¤íŒ¨ ì›ì¸ ë¶„ì„:"
            if grep -q "login" "$file"; then
              echo "   ğŸ” ë¡œê·¸ì¸ í˜ì´ì§€ ê°ì§€ë¨"
            fi
            if grep -q "error" "$file"; then
              echo "   âŒ ì—ëŸ¬ ë©”ì‹œì§€ ë°œê²¬"
              grep -i "error" "$file" | head -n 3
            fi
            if grep -q "captcha" "$file"; then
              echo "   ğŸ¤– ìº¡ì°¨ ê°ì§€ë¨"
            fi
            if grep -q "block" "$file"; then
              echo "   ğŸš« ì ‘ê·¼ ì°¨ë‹¨ ê°ì§€ë¨"
            fi
          fi
        done
        
        # ë¡œê·¸ íŒŒì¼ ìƒì„¸ ë¶„ì„
        if [ -f "grider_automation.log" ]; then
          echo "ğŸ“„ í¬ë¡¤ë§ ê´€ë ¨ ë¡œê·¸ ë¶„ì„:"
          echo "ğŸ” ë§ˆì§€ë§‰ í¬ë¡¤ë§ ì‹œë„:"
          grep -A 5 -B 5 "í¬ë¡¤ë§" grider_automation.log | tail -n 20
          
          echo "ğŸ” ì—ëŸ¬ ë©”ì‹œì§€:"
          grep -i "error\|ì‹¤íŒ¨\|ì˜¤ë¥˜" grider_automation.log | tail -n 10
          
          echo "ğŸ” ë¡œê·¸ì¸ ê´€ë ¨:"
          grep -i "login\|ë¡œê·¸ì¸" grider_automation.log | tail -n 5
        fi

    - name: ğŸŒ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
      if: success()
      run: |
        cd semiauto
        echo "ğŸŒ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘"
        
        # ì‹¤ì œ Gë¼ì´ë” ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ê°•ì œ ì—…ë°ì´íŠ¸
        echo "ğŸ”„ ì‹¤ì œ Gë¼ì´ë” ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
        python update_dashboard_with_real_data.py || echo "âš ï¸ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨"
        
        # ëŒ€ì‹œë³´ë“œ API ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if [ -f "dashboard/api/latest-data.json" ]; then
          echo "âœ… ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë°œê²¬ë¨. ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ ì‹œì‘..."
          python verify_dashboard_data.py
          
          # Git ì„¤ì •
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì»¤ë°‹
          git add dashboard/api/
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸŒ ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸

            ğŸ“Š ìë™ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S %Z')
            ğŸ¯ ì‹¤í–‰ ëª¨ë“œ: ${{ env.MODE }}
            âš¡ ìš°ì„ ìˆœìœ„: ${{ env.PRIORITY }}
            
            - ì‹¤ì‹œê°„ ì„±ê³¼ ë°ì´í„° ê°±ì‹ 
            - ì‹¤ì œ Gë¼ì´ë” í¬ë¡¤ë§ ë°ì´í„° ë°˜ì˜
            - ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
            - ë©”ì‹œì§€ ì„¤ì • ë™ê¸°í™”"
            
            git push
            echo "âœ… ëŒ€ì‹œë³´ë“œ ë°ì´í„° í‘¸ì‹œ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
        else
          echo "âš ï¸ ëŒ€ì‹œë³´ë“œ ë°ì´í„° íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          echo "ğŸ”„ ìˆ˜ë™ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì¬ì‹œë„..."
          python update_dashboard_with_real_data.py || echo "âŒ ìˆ˜ë™ ì—…ë°ì´íŠ¸ë„ ì‹¤íŒ¨"
        fi

    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¶„ì„
      if: always()
      run: |
        cd semiauto
        echo "ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¶„ì„"
        
        # ë¡œê·¸ íŒŒì¼ í™•ì¸
        if [ -f "grider_automation.log" ]; then
          echo "ğŸ“„ ì‹¤í–‰ ë¡œê·¸ ë§ˆì§€ë§‰ 10ì¤„:"
          tail -n 10 grider_automation.log
        fi
        
        if [ -f "ultimate_grider.log" ]; then
          echo "ğŸŒŸ ì°¨ì„¸ëŒ€ ì‹œìŠ¤í…œ ë¡œê·¸ ë§ˆì§€ë§‰ 10ì¤„:"
          tail -n 10 ultimate_grider.log
        fi
        
        # ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ í™•ì¸
        if [ -f "message_history.json" ]; then
          echo "ğŸ“¨ ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ìƒíƒœ:"
          python -c "
        import json
        try:
            with open('message_history.json', 'r') as f:
                data = json.load(f)
                total_sent = len(data.get('sent_messages', {}))
                total_failed = len(data.get('failed_messages', {}))
                print(f'âœ… ì „ì†¡ ì„±ê³µ: {total_sent}ê°œ')
                print(f'âŒ ì „ì†¡ ì‹¤íŒ¨: {total_failed}ê°œ')
                if total_sent > 0:
                    latest = max(data['sent_messages'].items(), key=lambda x: x[0])
                    print(f'ğŸ“… ë§ˆì§€ë§‰ ì „ì†¡: {latest[0]}')
        except Exception as e:
            print(f'âŒ íˆìŠ¤í† ë¦¬ ë¶„ì„ ì‹¤íŒ¨: {e}')
        "
        fi
        
        # AI ë¶„ì„ ë°ì´í„° í™•ì¸
        if [ -f "ai_analytics_data.json" ]; then
          echo "ğŸ¤– AI ë¶„ì„ ë°ì´í„° ìƒíƒœ:"
          python -c "
        import json
        try:
            with open('ai_analytics_data.json', 'r') as f:
                data = json.load(f)
                history_count = len(data.get('performance_history', []))
                print(f'ğŸ“Š ì„±ê³¼ íˆìŠ¤í† ë¦¬: {history_count}ê°œ ë°ì´í„°')
                if history_count > 0:
                    latest = data['performance_history'][-1]
                    print(f'ğŸ“ˆ ìµœê·¼ ì™„ë£Œìœ¨: {latest.get(\"mission_completion_rate\", 0):.1f}%')
                    print(f'ğŸ¯ ì´ìƒ ì ìˆ˜: {latest.get(\"anomaly_score\", 0):.2f}')
        except Exception as e:
            print(f'âŒ AI ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨: {e}')
        "
        fi
        
        # ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìƒíƒœ í™•ì¸
        if [ -f "dashboard/api/latest-data.json" ]; then
          echo "ğŸŒ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìƒíƒœ:"
          python -c "
        import json
        try:
            with open('dashboard/api/latest-data.json', 'r') as f:
                data = json.load(f)
                print(f'ğŸ“Š í˜„ì¬ ì ìˆ˜: {data.get(\"current_score\", 0)}ì ')
                print(f'âœ… ì™„ë£Œ ë¯¸ì…˜: {data.get(\"completed_missions\", 0)}ê°œ')
                print(f'ğŸï¸ í™œì„± ë¼ì´ë”: {data.get(\"active_riders\", 0)}ëª…')
                print(f'ğŸ’° ì˜ˆìƒ ìˆ˜ìµ: {data.get(\"estimated_income\", 0):,}ì›')
                print(f'ğŸ“… ì—…ë°ì´íŠ¸: {data.get(\"timestamp\", \"ì•Œ ìˆ˜ ì—†ìŒ\")}')
        except Exception as e:
            print(f'âŒ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨: {e}')
        "
        fi

    - name: ğŸ“ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ultimate-system-logs-${{ github.run_number }}
        path: |
          semiauto/*.log
          semiauto/*_history.json
          semiauto/*_data.json
          semiauto/*_cache.json
          semiauto/dashboard/api/*.json
        retention-days: 7

  performance-monitoring:
    name: ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: ultimate-automation
    if: always()
    
    steps:
    - name: ğŸ“¥ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: ultimate-system-logs-${{ github.run_number }}
        path: ./logs

    - name: ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ë¦¬í¬íŠ¸
      run: |
        echo "ğŸ“ˆ ì°¨ì„¸ëŒ€ Gë¼ì´ë” ì‹œìŠ¤í…œ ì„±ëŠ¥ ë¶„ì„"
        echo "=" $(printf '=%.0s' {1..50})
        
        # ì‹¤í–‰ ì„±ê³µ/ì‹¤íŒ¨ íŒì •
        if [ "${{ needs.ultimate-automation.result }}" == "success" ]; then
          echo "âœ… ì‹¤í–‰ ìƒíƒœ: ì„±ê³µ"
          echo "ğŸ‰ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒ ì‘ë™í–ˆìŠµë‹ˆë‹¤."
        else
          echo "âŒ ì‹¤í–‰ ìƒíƒœ: ì‹¤íŒ¨"
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œì ì„ íŒŒì•…í•´ì£¼ì„¸ìš”."
        fi
        
        echo ""
        echo "ğŸ“Š ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ:"
        echo "  ğŸ¤– AI ê¸°ë°˜ ì„±ê³¼ ì˜ˆì¸¡ ë° ì´ìƒ ê°ì§€"
        echo "  ğŸ” ì‹¤ì‹œê°„ ë°ì´í„° ê²€ì¦ ë° ìë™ ìˆ˜ì •"
        echo "  ğŸ“… ì •í™•í•œ ì‹œê°„ ê¸°ë°˜ ìŠ¤ì¼€ì¤„ë§"
        echo "  ğŸ”„ ëˆ„ë½ ë©”ì‹œì§€ ìë™ ë³µêµ¬"
        echo "  ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ìµœì í™”"
        echo "  ğŸŒ ì‹¤ì‹œê°„ ì›¹ ëŒ€ì‹œë³´ë“œ"
        echo "  ğŸŒŸ ì°¨ì„¸ëŒ€ í†µí•© ê´€ë¦¬"
        
        echo ""
        echo "ğŸ”— ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ğŸ“ ë¡œê·¸ ì•„í‹°íŒ©íŠ¸: ultimate-system-logs-${{ github.run_number }}"

  health-check:
    name: ğŸ¥ ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬
    runs-on: ubuntu-latest
    needs: ultimate-automation
    if: failure()
    
    steps:
    - name: ğŸš¨ ì‹œìŠ¤í…œ ì¥ì•  ì•Œë¦¼
      run: |
        echo "ğŸš¨ ì°¨ì„¸ëŒ€ Gë¼ì´ë” ì‹œìŠ¤í…œ ì¥ì•  ê°ì§€!"
        echo ""
        echo "ğŸ” ì¥ì•  ì •ë³´:"
        echo "  â€¢ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "  â€¢ ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}"
        echo "  â€¢ ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}"
        echo "  â€¢ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "  â€¢ ìˆ˜ë™ ì‹¤í–‰ ëª¨ë“œ: ${{ github.event.inputs.mode }}"
          echo "  â€¢ ìš°ì„ ìˆœìœ„: ${{ github.event.inputs.priority }}"
        fi
        
        echo ""
        echo "ğŸ› ï¸ ë³µêµ¬ ë°©ë²•:"
        echo "  1. Actions íƒ­ì—ì„œ ë¡œê·¸ í™•ì¸"
        echo "  2. ì•„í‹°íŒ©íŠ¸ì—ì„œ ìƒì„¸ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ"
        echo "  3. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ workflow_dispatch ì‹¤í–‰"
        echo "  4. ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸" 