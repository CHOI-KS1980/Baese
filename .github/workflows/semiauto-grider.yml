name: ğŸ¯ SemiAuto Gë¼ì´ë” ìë™í™”

on:
  schedule:
    # í•œêµ­ì‹œê°„(KST) = UTC + 9ì‹œê°„ì´ë¯€ë¡œ UTC ì‹œê°„ì€ -9ì‹œê°„ìœ¼ë¡œ ì„¤ì •
    
    # ê¸°ë³¸ 10ë¶„ ê°„ê²© (10:00~00:00 KST = 01:00~15:00 UTC)
    - cron: '0,10,20,30,40,50 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15 * * *'
    
    # í”¼í¬ì‹œê°„ 5ë¶„ ê°„ê²© ì¶”ê°€ (11-13ì‹œ, 17-19ì‹œ KST)
    # 11-13ì‹œ KST = 02-04ì‹œ UTC
    - cron: '5,15,25,35,45,55 2,3,4 * * *'
    # 17-19ì‹œ KST = 08-10ì‹œ UTC  
    - cron: '5,15,25,35,45,55 8,9,10 * * *'
    
  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì‹¤í–‰'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'

env:
  PYTHON_VERSION: '3.9'

jobs:
  grider-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd semiauto
        pip install --upgrade pip
        pip install -r config/requirements.txt
        
    - name: ğŸŒ Chrome ë¸Œë¼ìš°ì € ì„¤ì¹˜
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
        
    - name: ğŸ“‹ ChromeDriver ì„¤ì¹˜
      uses: nanasess/setup-chromedriver@v2
      
    - name: ğŸ”§ í™˜ê²½ ì„¤ì •
      run: |
        cd semiauto
        # config.txt íŒŒì¼ ìƒì„±
        echo "REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}" > config.txt
        echo "REFRESH_TOKEN=${{ secrets.KAKAO_REFRESH_TOKEN }}" >> config.txt
        
        # ê¶Œí•œ ì„¤ì •
        chmod +x config.txt
        
    - name: ğŸ¯ GitHub Actionsìš© ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      run: |
        cd semiauto
        cat > github_runner.py << 'EOF'
        import sys
        import os
        sys.path.append('.')
        
        from core.final_solution import GriderAutoSender, load_config
        import logging
        
        # ë¡œê¹… ì„¤ì •
        logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
        logger = logging.getLogger(__name__)
        
        def main():
            try:
                logger.info('ğŸš€ GitHub Actionsì—ì„œ Gë¼ì´ë” ìë™í™” ì‹œì‘')
                
                # ì„¤ì • ë¡œë“œ
                rest_api_key, refresh_token = load_config()
                if not rest_api_key or not refresh_token:
                    logger.error('âŒ ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨')
                    return False
                    
                # ìë™í™” ê°ì²´ ìƒì„±
                auto_sender = GriderAutoSender(rest_api_key, refresh_token)
                
                # ì—°ê²° í…ŒìŠ¤íŠ¸
                if not auto_sender.test_connection():
                    logger.error('âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨')
                    return False
                    
                # ë¦¬í¬íŠ¸ ì „ì†¡
                result = auto_sender.send_report()
                
                if result:
                    logger.info('âœ… GitHub Actions ìë™í™” ì™„ë£Œ!')
                    return True
                else:
                    logger.error('âŒ ë¦¬í¬íŠ¸ ì „ì†¡ ì‹¤íŒ¨')
                    return False
                    
            except Exception as e:
                logger.error(f'âŒ GitHub Actions ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}')
                return False
        
        if __name__ == '__main__':
            success = main()
            if not success:
                sys.exit(1)
        EOF
        
    - name: ğŸ¯ Gë¼ì´ë” ìë™í™” ì‹¤í–‰
      run: |
        cd semiauto
        python3 github_runner.py
        
    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "ğŸ¯ SemiAuto Gë¼ì´ë” ìë™í™” ì‹¤í–‰ ì™„ë£Œ"
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸŒ í•œêµ­ì‹œê°„: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
        echo ""
        echo "ğŸ“± ì¹´ì¹´ì˜¤í†¡ 'ë‚˜ì—ê²Œ ë³´ë‚´ê¸°'ë¡œ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“‹ ë©”ì‹œì§€ë¥¼ ë³µì‚¬í•˜ì—¬ ì˜¤í”ˆì±„íŒ…ë°©ì— ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”!" 