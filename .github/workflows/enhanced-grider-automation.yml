name: ğŸ¯ ê³ ë„í™”ëœ Gë¼ì´ë” ìë™í™” ì‹œìŠ¤í…œ

on:
  schedule:
    # === í•œêµ­ì‹œê°„ ê¸°ì¤€ ì •í™•í•œ ìŠ¤ì¼€ì¤„ (ë‹¨ìˆœí™”) ===
    # ë¹„í”¼í¬ì‹œê°„: ì •ê°, 30ë¶„ (í•œêµ­ì‹œê°„ 10:00-23:59)
    # í”¼í¬ì‹œê°„: ì •ê°, 15ë¶„, 30ë¶„, 45ë¶„
    
    # ğŸŒ… ì˜¤ì „ ì‹œì‘ (í•œêµ­ì‹œê°„ 10:00 = UTC 01:00)
    - cron: '0 1 * * *'
    
    # ğŸ“Š ë¹„í”¼í¬ ì •ì‹œ (í•œêµ­ì‹œê°„ 10:00-23:00 = UTC 01:00-14:00)
    - cron: '0 1,2,3,4,5,6,7,8,9,10,11,12,13,14 * * *'
    
    # ğŸ“Š ë¹„í”¼í¬ 30ë¶„ (í•œêµ­ì‹œê°„ 10:30-23:30 = UTC 01:30-14:30)  
    - cron: '30 1,2,3,4,5,6,7,8,9,10,11,12,13,14 * * *'
    
    # ğŸš€ í”¼í¬ì‹œê°„ 15ë¶„ ì¶”ê°€ (í•œêµ­ì‹œê°„ 06:00-19:59)
    # ì•„ì¹¨ì ì‹¬í”¼í¬ (06:00-13:59): í•œêµ­ì‹œê°„ = UTC 21:00-04:59 (ì „ë‚  21ì‹œë¶€í„°)
    - cron: '15,45 21,22,23,0,1,2,3,4 * * *'
    
    # ì˜¤í›„ë…¼í”¼í¬ + ì €ë…í”¼í¬ (13:00-19:59): í•œêµ­ì‹œê°„ = UTC 04:00-10:59
    - cron: '15,45 4,5,6,7,8,9,10 * * *'
    
    # ì‹¬ì•¼ë…¼í”¼í¬ (20:00-02:59): í•œêµ­ì‹œê°„ = UTC 11:00-17:59
    - cron: '15,45 11,12,13,14,15,16,17 * * *'
    
    # ğŸŒ™ ìì • ì¢…ë£Œ ë©”ì‹œì§€ (í•œêµ­ì‹œê°„ 00:00 = UTC 15:00)
    - cron: '0 15 * * *'
    
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - validation
        - recovery

env:
  PYTHONUNBUFFERED: 1
  PYTHONIOENCODING: utf-8
  TZ: Asia/Seoul
  LC_ALL: C.UTF-8
  LANG: C.UTF-8

jobs:
  enhanced-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # íƒ€ì„ì•„ì›ƒ ë‹¨ì¶•
    continue-on-error: false
    
    steps:
    - name: ğŸ“‹ ì‹¤í–‰ ì •ë³´ ì¶œë ¥
      run: |
        echo "ğŸ¯ ê³ ë„í™”ëœ Gë¼ì´ë” ìë™í™” ì‹¤í–‰"
        echo "ğŸ• UTC ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ‡°ğŸ‡· í•œêµ­ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”§ ì‹¤í–‰ ëª¨ë“œ: ${{ github.event.inputs.mode || 'scheduled' }}"
        echo "ğŸ”„ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
    
    - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python 3.11 ì„¤ì • (ìºì‹œ í™œìš©)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
        
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜ (ìµœì í™”)
      run: |
        echo "âš¡ ì´ˆê³ ì† ê²½ëŸ‰ ì„¤ì¹˜ ì‹œì‘..."
        python -m pip install --upgrade pip wheel setuptools
        
        # Gë¼ì´ë” ìë™í™” ìµœì†Œ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜ (11ê°œ íŒ¨í‚¤ì§€)
        pip install -r semiauto/requirements_minimal.txt --no-warn-script-location
        echo "âœ… ê²½ëŸ‰ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ (ê¸°ì¡´ 90ê°œ â†’ 11ê°œ íŒ¨í‚¤ì§€)"
        
    - name: ğŸŒ Chrome + ChromeDriver ì´ˆê³ ì† ì„¤ì¹˜ (ìµœì í™”)
      run: |
        echo "âš¡ ì´ˆê³ ì† Chrome ì„¤ì¹˜ ì‹œì‘..."
        
        # Chrome ë²„ì „ í™•ì¸ (ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ ì²´í¬)
        if command -v google-chrome &> /dev/null; then
          echo "âœ… Chrome ì´ë¯¸ ì„¤ì¹˜ë¨: $(google-chrome --version)"
        else
          # Chrome ê°„ë‹¨ ì„¤ì¹˜ (apt ìºì‹œ í™œìš©)
          sudo apt-get update -qq 2>/dev/null
          sudo apt-get install -y -qq google-chrome-stable 2>/dev/null
          echo "âœ… Chrome ì‹ ê·œ ì„¤ì¹˜ ì™„ë£Œ"
        fi
        
        # ChromeDriver ì‚¬ì „ ì„¤ì¹˜ëœ ê²ƒ ì‚¬ìš© ë˜ëŠ” ë¹ ë¥¸ ì„¤ì¹˜
        if [ -f "/usr/bin/chromedriver" ]; then
          echo "âœ… ì‹œìŠ¤í…œ ChromeDriver ì‚¬ìš©: /usr/bin/chromedriver"
          sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
        elif [ -f "/usr/local/share/chrome_driver/chromedriver" ]; then
          echo "âœ… ì‚¬ì „ ì„¤ì¹˜ëœ ChromeDriver ì‚¬ìš©"
          sudo ln -sf /usr/local/share/chrome_driver/chromedriver /usr/local/bin/chromedriver
        else
          # ë¹ ë¥¸ ChromeDriver ì„¤ì¹˜ (ìºì‹œëœ ë²„ì „ ì‚¬ìš©)
          echo "âš¡ ChromeDriver ë¹ ë¥¸ ì„¤ì¹˜..."
          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+' | head -1)
          MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
          
          # Chrome for Testing API ì‚¬ìš© (ë” ë¹ ë¦„)
          CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/LATEST_RELEASE_$MAJOR_VERSION"
          CHROMEDRIVER_VERSION=$(curl -s $CHROMEDRIVER_URL)
          
          wget -q -O /tmp/chromedriver.zip "https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          sudo unzip -qq /tmp/chromedriver.zip -d /tmp/
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          rm -f /tmp/chromedriver.zip
        fi
        
        echo "âœ… Chrome ì„¤ì¹˜ ì™„ë£Œ: $(google-chrome --version)"
        echo "âœ… ChromeDriver ì„¤ì¹˜ ì™„ë£Œ: $(chromedriver --version)"
        
    - name: âš™ï¸ ì„¤ì • íŒŒì¼ ë° í™˜ê²½ë³€ìˆ˜ ìƒì„±
      run: |
        cd semiauto
        echo "REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}" > config.txt
        echo "REFRESH_TOKEN=${{ secrets.KAKAO_REFRESH_TOKEN }}" >> config.txt
        echo "GRIDER_ID=${{ secrets.GRIDER_ID }}" >> config.txt
        echo "GRIDER_PASSWORD=${{ secrets.GRIDER_PASSWORD }}" >> config.txt
        echo "âœ… ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ"
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (í•œêµ­ ê³µíœ´ì¼ API í‚¤)
        echo "KOREA_HOLIDAY_API_KEY=${{ secrets.KOREA_HOLIDAY_API_KEY || 'default_key' }}" >> $GITHUB_ENV
        echo "âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
        
    - name: ğŸ¯ ê³ ë„í™”ëœ ìë™í™” ì‹¤í–‰
      run: |
        cd semiauto
        echo "ğŸš€ ê³ ë„í™”ëœ ì‹œìŠ¤í…œ ì‹œì‘..."
        
        # ì‹¤í–‰ ëª¨ë“œì— ë”°ë¥¸ ë¶„ê¸°
        MODE="${{ github.event.inputs.mode }}"
        
        if [ "$MODE" = "validation" ]; then
          echo "ğŸ” ê²€ì¦ ëª¨ë“œ ì‹¤í–‰"
          python core/enhanced_final_solution.py --validation
        elif [ "$MODE" = "recovery" ]; then
          echo "ğŸ”„ ë³µêµ¬ ëª¨ë“œ ì‹¤í–‰"
          python core/enhanced_final_solution.py --single-run --recovery
        else
          echo "ğŸ“¤ ì¼ë°˜ ì „ì†¡ ëª¨ë“œ ì‹¤í–‰"
          python core/enhanced_final_solution.py --single-run
        fi
        
    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ í™•ì¸
      if: always()
      run: |
        cd semiauto
        echo "ğŸ“‹ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½:"
        
        # ë¡œê·¸ íŒŒì¼ í™•ì¸
        if [ -f "grider_automation.log" ]; then
          echo "ğŸ“„ ë¡œê·¸ íŒŒì¼ í¬ê¸°: $(wc -l < grider_automation.log) ì¤„"
          echo "ğŸ” ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 10ì¤„):"
          tail -10 grider_automation.log
        fi
        
        # íˆìŠ¤í† ë¦¬ íŒŒì¼ í™•ì¸
        if [ -f "message_history.json" ]; then
          echo "ğŸ“ ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì¡´ì¬: $(wc -c < message_history.json) bytes"
        fi
        
        # ë°ì´í„° ìºì‹œ í™•ì¸
        if [ -f "data_cache.json" ]; then
          echo "ğŸ’¾ ë°ì´í„° ìºì‹œ ì¡´ì¬: $(wc -c < data_cache.json) bytes"
        fi
        
    - name: ğŸ“ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ì‹œì—ë§Œ)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          semiauto/grider_automation.log
          semiauto/message_history.json
          semiauto/data_cache.json
          semiauto/debug_grider_page.html
        retention-days: 2
        if-no-files-found: warn
        
    - name: âš ï¸ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      run: |
        echo "âŒ ê³ ë„í™”ëœ ìë™í™” ì‹¤í–‰ ì‹¤íŒ¨"
        echo "ğŸ” ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
        
  # ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì¡ (ê°„ì†Œí™”)
  status-check:
    runs-on: ubuntu-latest
    needs: enhanced-automation
    if: always()
    
    steps:
    - name: ğŸ“Š ì‹¤í–‰ ìƒíƒœ í™•ì¸
      run: |
        echo "ğŸ¯ ê³ ë„í™”ëœ ìë™í™” ì‹¤í–‰ ì™„ë£Œ"
        echo "ğŸ“ˆ ìƒíƒœ: ${{ needs.enhanced-automation.result }}"
        
        if [ "${{ needs.enhanced-automation.result }}" = "success" ]; then
          echo "âœ… ì •ìƒ ì‹¤í–‰ë¨"
        else
          echo "âŒ ì‹¤í–‰ ì‹¤íŒ¨ - í™•ì¸ í•„ìš”"
        fi 