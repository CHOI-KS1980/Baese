name: ğŸ§¹ ìë™ ë¡œê·¸ ì •ë¦¬ ë° ë¦¬í¬ì§€í† ë¦¬ ìµœì í™”

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 7ì‹œ30ë¶„ (í•œêµ­ì‹œê°„ 07:30 = UTC 22:30 ì „ë‚ ) - ë©”ì‹œì§€ ì‹œê°„ ì™„ì „ íšŒí”¼
    - cron: '30 22 * * *'
    
    # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 7ì‹œ (í•œêµ­ì‹œê°„ 07:00 = UTC 22:00 í† ìš”ì¼) - ë©”ì‹œì§€ ì‹œê°„ ì™„ì „ íšŒí”¼
    - cron: '0 22 * * 6'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'ì •ë¦¬ ìœ í˜• ì„ íƒ'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - aggressive
        - report_only
      
      auto_commit:
        description: 'ìë™ ì»¤ë°‹ ì—¬ë¶€'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  cleanup-logs:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (Git ì¶©ëŒ ë°©ì§€)
    concurrency:
      group: log-cleanup
      cancel-in-progress: false
    
    if: github.repository == github.event.repository.full_name
    
    steps:
    - name: ğŸ›’ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install --no-deps -r requirements.txt
        pip install schedule pathlib
    
    - name: ğŸ• ì‹œê°„ ì •ë³´ ì¶œë ¥
      run: |
        echo "ğŸš€ ë¡œê·¸ ì •ë¦¬ ì‹œì‘"
        echo "â° UTC ì‹œê°„: $(date -u)"
        echo "ğŸ‡°ğŸ‡· í•œêµ­ ì‹œê°„: $(TZ='Asia/Seoul' date)"
        echo "ğŸ¯ ì •ë¦¬ ìœ í˜•: ${{ github.event.inputs.cleanup_type || 'scheduled' }}"
    
    - name: ğŸ“Š ì •ë¦¬ ì „ ìƒíƒœ í™•ì¸
      run: |
        echo "=== ì •ë¦¬ ì „ ìƒíƒœ ==="
        echo "ğŸ“ ì „ì²´ íŒŒì¼ ìˆ˜: $(find . -type f | wc -l)"
        echo "ğŸ“Š ë¡œê·¸ íŒŒì¼ ìˆ˜: $(find . -name "*.log" -o -name "debug_*.html" | wc -l)"
        echo "ğŸ’¾ ë¡œê·¸ íŒŒì¼ í¬ê¸°: $(find . -name "*.log" -o -name "debug_*.html" -exec ls -lh {} \; | awk '{sum+=$5} END {print sum/1024/1024 " MB"}')"
        echo "ğŸ—‚ï¸ ë¦¬í¬ì§€í† ë¦¬ í¬ê¸°: $(du -sh . | cut -f1)"
    
    - name: ğŸ§¹ ë¡œê·¸ íŒŒì¼ ì •ë¦¬ ì‹¤í–‰
      run: |
        if [ "${{ github.event.inputs.cleanup_type }}" = "report_only" ]; then
          echo "ğŸ“‹ ë¦¬í¬íŠ¸ë§Œ ìƒì„±í•©ë‹ˆë‹¤..."
          python log_cleanup_system.py report
                 elif [ "${{ github.event.inputs.cleanup_type }}" = "aggressive" ]; then
           echo "ğŸ”¥ ê°•ë ¥ ì •ë¦¬ ëª¨ë“œ..."
           # ë” ì—„ê²©í•œ ì„¤ì •ìœ¼ë¡œ ì •ë¦¬
           echo '{"max_file_size_mb":5,"max_age_days":3,"keep_compressed_days":14,"log_directories":[".","logs/","semiauto/","autoinfo/","kakao/"],"log_patterns":["*.log","debug_*.html","*.debug","*.tmp","*.cache"],"github_cleanup":{"enabled":true,"auto_commit":true}}' > log_cleanup_config.json
           python log_cleanup_system.py cleanup
        else
          echo "ğŸ“ ì¼ë°˜ ì •ë¦¬ ëª¨ë“œ..."
          python log_cleanup_system.py cleanup
        fi
    
    - name: ğŸ“Š ì •ë¦¬ í›„ ìƒíƒœ í™•ì¸
      run: |
        echo "=== ì •ë¦¬ í›„ ìƒíƒœ ==="
        echo "ğŸ“ ì „ì²´ íŒŒì¼ ìˆ˜: $(find . -type f | wc -l)"
        echo "ğŸ“Š ë‚¨ì€ ë¡œê·¸ íŒŒì¼: $(find . -name "*.log" -o -name "debug_*.html" | wc -l)"
        echo "ğŸ—‚ï¸ ë¦¬í¬ì§€í† ë¦¬ í¬ê¸°: $(du -sh . | cut -f1)"
        echo ""
        echo "ğŸ—œï¸ ì••ì¶•ëœ íŒŒì¼: $(find . -name "*.gz" | wc -l)ê°œ"
        echo "ğŸ“‹ ì •ë¦¬ ë¦¬í¬íŠ¸:"
        python log_cleanup_system.py report
    
    - name: ğŸ”„ Git ìƒíƒœ í™•ì¸
      id: git-status
      run: |
        git status --porcelain > git_changes.txt
        if [ -s git_changes.txt ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨:"
          cat git_changes.txt
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi
    
    - name: ğŸ“¤ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      if: steps.git-status.outputs.has_changes == 'true' && (github.event.inputs.auto_commit != 'false')
      run: |
        # Git ì‚¬ìš©ì ì„¤ì •
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # .gitignore ì—…ë°ì´íŠ¸ í™•ì¸
        git add .gitignore
        git add log_cleanup_system.py
        git add .github/workflows/log-cleanup.yml
        
        # ë¡œê·¸ íŒŒì¼ë“¤ì´ ì‹¤ìˆ˜ë¡œ ì¶”ê°€ë˜ì§€ ì•Šë„ë¡ ì œê±°
        git rm --cached *.log 2>/dev/null || true
        git rm --cached debug_*.html 2>/dev/null || true
        git rm --cached semiauto/*.log 2>/dev/null || true
        git rm --cached semiauto/debug_*.html 2>/dev/null || true
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
        CLEANUP_TYPE="${{ github.event.inputs.cleanup_type || 'scheduled' }}"
        COMMIT_MSG="ğŸ§¹ ìë™ ë¡œê·¸ ì •ë¦¬ ($CLEANUP_TYPE) - $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M')"
        
        # ì»¤ë°‹ ë° í‘¸ì‹œ
        git commit -m "$COMMIT_MSG" || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        git push origin main || echo "í‘¸ì‹œ ì‹¤íŒ¨ - ì¶©ëŒ ê°€ëŠ¥ì„±"
    
    - name: ğŸ“ˆ ì •ë¦¬ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "::notice::ğŸ§¹ ë¡œê·¸ ì •ë¦¬ ì‘ì—… ì™„ë£Œ"
        
        if [ "${{ steps.git-status.outputs.has_changes }}" = "true" ]; then
          echo "::notice::ğŸ“ ë³€ê²½ì‚¬í•­ì´ ìë™ìœ¼ë¡œ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤"
        else
          echo "::notice::âœ… ì •ë¦¬í•  í•­ëª©ì´ ì—†ì—ˆìŠµë‹ˆë‹¤"
        fi
        
        echo ""
        echo "ğŸ“Š ìµœì¢… ìƒíƒœ:"
        echo "â€¢ ì‹¤í–‰ ì‹œê°„: $(TZ='Asia/Seoul' date)"
        echo "â€¢ ì •ë¦¬ ìœ í˜•: ${{ github.event.inputs.cleanup_type || 'scheduled' }}"
        echo "â€¢ ìë™ ì»¤ë°‹: ${{ github.event.inputs.auto_commit || 'true' }}"
    
    - name: ğŸš¨ ì‹¤íŒ¨ì‹œ ì•Œë¦¼
      if: failure()
      run: |
        echo "::error::âŒ ë¡œê·¸ ì •ë¦¬ ì‘ì—… ì‹¤íŒ¨"
        echo "::error::ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”" 