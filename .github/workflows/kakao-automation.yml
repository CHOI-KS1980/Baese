name: ğŸ¤– ì¹´ì¹´ì˜¤í†¡ ë‚˜ì—ê²Œ ë³´ë‚´ê¸° ìë™í™”

on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (UTC ê¸°ì¤€) - 10:00~00:00 ìš´ì˜ì‹œê°„
  schedule:
    # ì˜¤ì „ 10ì‹œ ì‹œì‘ ë©”ì‹œì§€ (í•œêµ­ì‹œê°„ 10:00 = UTC 01:00)
    - cron: '0 1 * * *'   # 10:00 ì‹œì‘ ì•Œë¦¼
    
    # 30ë¶„ ê°„ê²© ê¸°ë³¸ ì•Œë¦¼ (10:30~23:30, ë…¼í”¼í¬ ì‹œê°„)
    - cron: '30 1 * * *'  # 10:30
    - cron: '0 2 * * *'   # 11:00
    - cron: '0 3 * * *'   # 12:00
    - cron: '30 3 * * *'  # 12:30
    - cron: '0 4 * * *'   # 13:00
    - cron: '30 4 * * *'  # 13:30
    - cron: '0 5 * * *'   # 14:00
    - cron: '30 5 * * *'  # 14:30
    - cron: '0 6 * * *'   # 15:00
    - cron: '30 6 * * *'  # 15:30
    - cron: '0 7 * * *'   # 16:00
    - cron: '30 7 * * *'  # 16:30
    - cron: '0 8 * * *'   # 17:00
    - cron: '30 8 * * *'  # 17:30
    - cron: '0 9 * * *'   # 18:00
    - cron: '30 9 * * *'  # 18:30
    - cron: '0 10 * * *'  # 19:00
    - cron: '30 10 * * *' # 19:30
    - cron: '0 11 * * *'  # 20:00
    - cron: '30 11 * * *' # 20:30
    - cron: '0 12 * * *'  # 21:00
    - cron: '30 12 * * *' # 21:30
    - cron: '0 13 * * *'  # 22:00
    - cron: '30 13 * * *' # 22:30
    - cron: '0 14 * * *'  # 23:00
    - cron: '30 14 * * *' # 23:30
    
    # í”¼í¬ì‹œê°„ 15ë¶„ ê°„ê²© ì¶”ê°€ ì•Œë¦¼ (11:30-14:00, 17:00-21:00)
    # ì ì‹¬í”¼í¬ (11:30-14:00)
    - cron: '45 2 * * *'  # 11:45
    - cron: '15 3 * * *'  # 12:15
    - cron: '45 3 * * *'  # 12:45
    - cron: '15 4 * * *'  # 13:15
    - cron: '45 4 * * *'  # 13:45
    
    # ì €ë…í”¼í¬ (17:00-21:00)
    - cron: '15 8 * * *'  # 17:15
    - cron: '45 8 * * *'  # 17:45
    - cron: '15 9 * * *'  # 18:15
    - cron: '45 9 * * *'  # 18:45
    - cron: '15 10 * * *' # 19:15
    - cron: '45 10 * * *' # 19:45
    - cron: '15 11 * * *' # 20:15
    - cron: '45 11 * * *' # 20:45
    
    # ìì • ë§ˆë¬´ë¦¬ ë©”ì‹œì§€ (í•œêµ­ì‹œê°„ 00:00 = UTC 15:00)
    - cron: '0 15 * * *'  # 00:00 ìì • ë§ˆë¬´ë¦¬
  
  # ìˆ˜ë™ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      report_type:
        description: 'ë¦¬í¬íŠ¸ íƒ€ì…'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - start_day
        - regular
        - lunch_peak
        - dinner_peak
        - midnight

  # í‘¸ì‹œì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (main ë¸Œëœì¹˜)
  push:
    branches: [ main ]
    paths: 
      - 'github_actions_memo_automation.py'
      - '.github/workflows/kakao-automation.yml'

jobs:
  send-kakao-message:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz
        # ì„ íƒì  íŒ¨í‚¤ì§€ (ì˜¤ë¥˜ ë¬´ì‹œ)
        pip install python-dotenv || true
    
    - name: ğŸ• í•œêµ­ì‹œê°„ í™•ì¸
      run: |
        echo "Current UTC time: $(date -u)"
        echo "Current KST time: $(TZ=Asia/Seoul date)"
        python -c "
        import pytz
        from datetime import datetime
        kst = pytz.timezone('Asia/Seoul')
        now_kst = datetime.now(kst)
        print(f'Python KST time: {now_kst.strftime(\"%Y-%m-%d %H:%M:%S %Z\")}')
        print(f'Hour: {now_kst.hour}')
        "
    
    - name: ğŸ¤– ë¦¬í¬íŠ¸ íƒ€ì… ê²°ì •
      id: report-type
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          REPORT_TYPE="${{ github.event.inputs.report_type }}"
        elif [ "${{ github.event_name }}" = "push" ]; then
          REPORT_TYPE="test"
        else
          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì‹œ ì‹œê°„ê³¼ ë¶„ì— ë”°ë¼ ê²°ì •
          HOUR=$(TZ=Asia/Seoul date +%H)
          MINUTE=$(TZ=Asia/Seoul date +%M)
          
          case $HOUR in
            10)
              if [ "$MINUTE" = "00" ]; then
                REPORT_TYPE="start_day"  # í•˜ë£¨ ì‹œì‘ ë©”ì‹œì§€
              else
                REPORT_TYPE="regular"    # ì¼ë°˜ ì—…ë°ì´íŠ¸
              fi
              ;;
            00)
              REPORT_TYPE="midnight"     # ìì • ë§ˆë¬´ë¦¬ ë©”ì‹œì§€
              ;;
            11|12|13)
              # ì ì‹¬í”¼í¬ ì‹œê°„ (11:30-14:00)
              REPORT_TYPE="lunch_peak"
              ;;
            17|18|19|20)
              # ì €ë…í”¼í¬ ì‹œê°„ (17:00-21:00)  
              REPORT_TYPE="dinner_peak"
              ;;
            *)
              # ë…¼í”¼í¬ ì‹œê°„ (30ë¶„ ê°„ê²©)
              REPORT_TYPE="regular"
              ;;
          esac
        fi
        
        echo "REPORT_TYPE=$REPORT_TYPE" >> $GITHUB_OUTPUT
        echo "ğŸ¯ ê²°ì •ëœ ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE (í•œêµ­ì‹œê°„: $(TZ=Asia/Seoul date +%H:%M))"
    
    - name: ğŸ“Š ì¹´ì¹´ì˜¤í†¡ ìë™í™” ì‹¤í–‰
      env:
        KAKAO_ACCESS_TOKEN: ${{ secrets.KAKAO_ACCESS_TOKEN }}
        OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        REPORT_TYPE: ${{ steps.report-type.outputs.REPORT_TYPE }}
      run: |
        echo "ğŸš€ GitHub Actions ì¹´ì¹´ì˜¤í†¡ ìë™í™” ì‹¤í–‰"
        echo "ğŸ“‹ ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ğŸ”‘ í† í° í™•ì¸: ${KAKAO_ACCESS_TOKEN:0:10}..."
        
        python github_actions_memo_automation.py $REPORT_TYPE
    
    - name: ğŸ“ˆ ì‹¤í–‰ ê²°ê³¼ ê¸°ë¡
      if: always()
      run: |
        echo "::notice::ì¹´ì¹´ì˜¤í†¡ ìë™í™” ì‹¤í–‰ ì™„ë£Œ - íƒ€ì…: ${{ steps.report-type.outputs.REPORT_TYPE }}"
        
        if [ $? -eq 0 ]; then
          echo "::notice::âœ… ì „ì†¡ ì„±ê³µ"
        else
          echo "::error::âŒ ì „ì†¡ ì‹¤íŒ¨"
        fi
    
    - name: ğŸš¨ ì‹¤íŒ¨ì‹œ ì´ìŠˆ ìƒì„±
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ ì¹´ì¹´ì˜¤í†¡ ìë™í™” ì‹¤íŒ¨ - ${new Date().toISOString().slice(0,10)}`,
            body: `## ğŸš¨ ìë™í™” ì‹¤íŒ¨ ì•Œë¦¼
            
            **ì‹¤í–‰ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
            **ë¦¬í¬íŠ¸ íƒ€ì…**: ${{ steps.report-type.outputs.REPORT_TYPE }}
            **ì›Œí¬í”Œë¡œìš°**: ${{ github.workflow }}
            **ì‹¤í–‰ ID**: ${{ github.run_id }}
            
            ### ğŸ” í™•ì¸ì‚¬í•­
            - [ ] KAKAO_ACCESS_TOKEN ë§Œë£Œ ì—¬ë¶€
            - [ ] API ì‚¬ìš©ëŸ‰ ì´ˆê³¼ ì—¬ë¶€  
            - [ ] ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ
            - [ ] ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ ë¡œê·¸
            
            ### ğŸ”— ê´€ë ¨ ë§í¬
            - [ì‹¤í–‰ ë¡œê·¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ì›Œí¬í”Œë¡œìš° íŒŒì¼](https://github.com/${{ github.repository }}/blob/main/.github/workflows/kakao-automation.yml)
            
            > ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì œ í•´ê²° í›„ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.`,
            labels: ['bug', 'automation', 'kakao']
          });
          
          console.log(`ì´ìŠˆ ìƒì„±ë¨: ${issue.data.html_url}`);

  # í† í° ë§Œë£Œ ì²´í¬ (ì£¼ê°„)
  check-token:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        pip install requests
    
    - name: ğŸ” í† í° ìœ íš¨ì„± ê²€ì‚¬
      env:
        KAKAO_ACCESS_TOKEN: ${{ secrets.KAKAO_ACCESS_TOKEN }}
      run: |
        python -c "
        import requests
        import os
        
        token = os.getenv('KAKAO_ACCESS_TOKEN')
        if not token:
            print('âŒ í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
            exit(1)
        
        # ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ APIë¡œ í† í° ìœ íš¨ì„± í™•ì¸
        url = 'https://kapi.kakao.com/v2/user/me'
        headers = {'Authorization': f'Bearer {token}'}
        
        response = requests.get(url, headers=headers)
        
        if response.status_code == 200:
            print('âœ… í† í°ì´ ìœ íš¨í•©ë‹ˆë‹¤.')
        elif response.status_code == 401:
            print('âš ï¸ í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¬´íš¨í•©ë‹ˆë‹¤.')
            exit(1)
        else:
            print(f'âš ï¸ í† í° í™•ì¸ ì‹¤íŒ¨: {response.status_code}')
            exit(1)
        "
    
    - name: âš ï¸ í† í° ë§Œë£Œ ì•Œë¦¼
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `âš ï¸ ì¹´ì¹´ì˜¤ í† í° ë§Œë£Œ ì•Œë¦¼ - ${new Date().toISOString().slice(0,10)}`,
            body: `## âš ï¸ ì¹´ì¹´ì˜¤ í† í° ë§Œë£Œ ì•Œë¦¼
            
            **í™•ì¸ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
            
            ### ğŸ”„ í•´ê²° ë°©ë²•
            1. \`ì¹´ì¹´ì˜¤_í† í°_ìƒì„±ê¸°.py\` ì‹¤í–‰
            2. ìƒˆ í† í° ë°œê¸‰ë°›ê¸°
            3. GitHub Secretsì—ì„œ \`KAKAO_ACCESS_TOKEN\` ì—…ë°ì´íŠ¸
            
            ### ğŸ“‹ ì„¤ì • ê²½ë¡œ
            - Settings â†’ Secrets and variables â†’ Actions
            - \`KAKAO_ACCESS_TOKEN\` ê°’ ì—…ë°ì´íŠ¸
            
            > í† í°ì„ ì—…ë°ì´íŠ¸í•œ í›„ ì´ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.`,
            labels: ['maintenance', 'token', 'urgent']
          });

  # í†µê³„ ìˆ˜ì§‘ (ì›”ê°„)
  monthly-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 1 * *'  # ë§¤ì›” 1ì¼
    
    steps:
    - name: ğŸ“Š ì›”ê°„ í†µê³„ ìˆ˜ì§‘
      run: |
        echo "ğŸ“Š ì›”ê°„ ìë™í™” í†µê³„ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤..."
        echo "ì´ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤." 